# API Testing Guide - Shift Registration Renewal & Batch Jobs (BE-307)

## Overview

This guide provides comprehensive testing instructions for:

1. **Shift Renewal Request API** - Part-time employee registration renewal workflow
2. **Scheduled Batch Jobs** - Automated shift generation and renewal detection
3. **Employee Shifts** - Final scheduled shifts generated by batch jobs

---

## Base URLs

### Shift Renewal API

```
http://localhost:8080/api/v1/registrations/renewals
```

### Employee Shifts API

```
http://localhost:8080/api/v1/employee-shifts
```

---

## Authentication

All requests require JWT Bearer Token:

```
Authorization: Bearer <your_jwt_token>
```

---

## RBAC Permissions

| Permission                | Description                                   |
| ------------------------- | --------------------------------------------- |
| `VIEW_RENEWAL_OWN`        | Xem yêu cầu gia hạn ca của bản thân           |
| `RESPOND_RENEWAL_OWN`     | Phản hồi (CONFIRMED/DECLINED) yêu cầu gia hạn |
| `VIEW_EMPLOYEE_SHIFT_ALL` | Xem tất cả lịch ca làm việc                   |
| `VIEW_EMPLOYEE_SHIFT_OWN` | Xem lịch ca làm việc của chính mình           |

---

## Entity Structures

### Shift Renewal Request

```json
{
  "renewalId": "SRR251022001",
  "expiringRegistrationId": "ESR250101001",
  "employeeId": 2,
  "employeeName": "Nguyen Van B",
  "status": "PENDING_ACTION",
  "expiresAt": "2025-10-29T23:59:59",
  "confirmedAt": null,
  "message": "Đăng ký ca làm việc của bạn sẽ hết hạn vào ngày 30/10/2025...",
  "registrationDetails": {
    "registrationId": "ESR250101001",
    "effectiveFrom": "2025-01-01",
    "effectiveTo": "2025-10-30",
    "registeredDays": ["MONDAY", "WEDNESDAY", "FRIDAY"],
    "workShifts": [
      {
        "shiftId": "SLOT_MORNING",
        "shiftName": "Ca sáng",
        "startTime": "07:00:00",
        "endTime": "12:00:00"
      }
    ]
  },
  "createdAt": "2025-10-22T01:00:00",
  "updatedAt": "2025-10-22T01:00:00"
}
```

### Employee Shift

```json
{
  "shiftId": 1,
  "employeeId": 1,
  "employeeName": "Nguyen Van A",
  "workDate": "2025-10-23",
  "workShift": {
    "shiftId": "SLOT_MORNING",
    "shiftName": "Ca sáng",
    "startTime": "07:00:00",
    "endTime": "12:00:00"
  },
  "source": "BATCH_JOB",
  "registrationId": null,
  "status": "SCHEDULED",
  "notes": "Ca sáng thứ 2",
  "createdAt": "2025-10-20T02:00:00",
  "updatedAt": "2025-10-20T02:00:00"
}
```

---

## PART 1: Shift Renewal Request API

### Test Case 1.1: Get Pending Renewals (VIEW_RENEWAL_OWN)

**Objective:** Part-time employee views their pending renewal requests

**Prerequisites:**

- Login as part-time employee with `VIEW_RENEWAL_OWN` permission
- Employee has at least one PENDING_ACTION renewal request

**Request:**

```bash
GET /api/v1/registrations/renewals/pending
Authorization: Bearer <employee_token>
```

**Expected Response:** `200 OK`

```json
{
  "renewals": [
    {
      "renewalId": "SRR251022001",
      "expiringRegistrationId": "ESR250101001",
      "employeeId": 2,
      "employeeName": "Nguyen Van B",
      "status": "PENDING_ACTION",
      "expiresAt": "2025-10-29T23:59:59",
      "message": "Đăng ký ca làm việc của bạn sẽ hết hạn vào ngày 30/10/2025. Vui lòng xác nhận gia hạn thêm 3 tháng.",
      "registrationDetails": {
        "registrationId": "ESR250101001",
        "effectiveFrom": "2025-01-01",
        "effectiveTo": "2025-10-30",
        "registeredDays": ["MONDAY", "WEDNESDAY", "FRIDAY"],
        "workShifts": [
          {
            "shiftId": "SLOT_MORNING",
            "shiftName": "Ca sáng",
            "startTime": "07:00:00",
            "endTime": "12:00:00"
          }
        ]
      },
      "daysUntilExpiry": 7,
      "createdAt": "2025-10-22T01:00:00"
    }
  ],
  "totalPending": 1
}
```

**Validation:**

- ✅ Returns only PENDING_ACTION renewals for current employee
- ✅ Includes full registration details for decision-making
- ✅ Shows daysUntilExpiry countdown
- ✅ Sorted by expiresAt (closest deadline first)

---

### Test Case 1.2: No Pending Renewals

**Objective:** Employee with no pending renewals receives empty list

**Request:**

```bash
GET /api/v1/registrations/renewals/pending
Authorization: Bearer <employee_token_no_renewals>
```

**Expected Response:** `200 OK`

```json
{
  "renewals": [],
  "totalPending": 0,
  "message": "Không có yêu cầu gia hạn nào đang chờ xử lý"
}
```

---

### Test Case 1.3: Forbidden - No Permission

**Objective:** User without VIEW_RENEWAL_OWN permission

**Request:**

```bash
GET /api/v1/registrations/renewals/pending
Authorization: Bearer <admin_token_no_permission>
```

**Expected Response:** `403 FORBIDDEN`

```json
{
  "status": 403,
  "message": "Access Denied",
  "timestamp": "2025-10-22T14:00:00"
}
```

---

### Test Case 1.4: Respond to Renewal - CONFIRMED (RESPOND_RENEWAL_OWN)

**Objective:** Employee confirms renewal (extends registration by 3 months)

**Prerequisites:**

- Login as employee with `RESPOND_RENEWAL_OWN` permission
- Employee owns the renewal request
- Renewal is in PENDING_ACTION status

**Request:**

```bash
PATCH /api/v1/registrations/renewals/SRR251022001/respond
Authorization: Bearer <employee_token>
Content-Type: application/json

{
  "action": "CONFIRMED"
}
```

**Expected Response:** `200 OK`

```json
{
  "renewalId": "SRR251022001",
  "expiringRegistrationId": "ESR250101001",
  "employeeId": 2,
  "status": "CONFIRMED",
  "confirmedAt": "2025-10-22T14:05:00",
  "message": "Đăng ký ca làm việc đã được gia hạn thành công đến ngày 30/01/2026 (thêm 3 tháng)",
  "registrationDetails": {
    "registrationId": "ESR250101001",
    "effectiveFrom": "2025-01-01",
    "effectiveTo": "2026-01-30",
    "registeredDays": ["MONDAY", "WEDNESDAY", "FRIDAY"]
  },
  "updatedAt": "2025-10-22T14:05:00"
}
```

**Validation:**

- ✅ Status changed from PENDING_ACTION to CONFIRMED
- ✅ confirmedAt timestamp set
- ✅ **Registration's effectiveTo extended by 3 months** (2025-10-30 → 2026-01-30)
- ✅ Employee can continue working with same schedule

**Database Verification:**

```sql
SELECT * FROM working_schedule WHERE registration_id = 'ESR250101001';
-- effective_to should be '2026-01-30' (original + 3 months)
```

---

### Test Case 1.5: Respond to Renewal - DECLINED

**Objective:** Employee declines renewal (will not extend registration)

**Request:**

```bash
PATCH /api/v1/registrations/renewals/SRR251022002/respond
Authorization: Bearer <employee_token>
Content-Type: application/json

{
  "action": "DECLINED"
}
```

**Expected Response:** `200 OK`

```json
{
  "renewalId": "SRR251022002",
  "expiringRegistrationId": "ESR250201001",
  "employeeId": 5,
  "status": "DECLINED",
  "confirmedAt": "2025-10-22T14:10:00",
  "message": "Bạn đã từ chối gia hạn. Đăng ký ca làm việc sẽ kết thúc vào ngày 30/10/2025.",
  "registrationDetails": {
    "registrationId": "ESR250201001",
    "effectiveTo": "2025-10-30"
  },
  "updatedAt": "2025-10-22T14:10:00"
}
```

**Validation:**

- ✅ Status changed to DECLINED
- ✅ Registration's effectiveTo **NOT changed** (remains original date)
- ✅ Employee will stop working after effectiveTo date

---

### Test Case 1.6: Validation Error - Invalid Action

**Objective:** Test validation for action field

**Request:**

```bash
PATCH /api/v1/registrations/renewals/SRR251022001/respond
Authorization: Bearer <employee_token>
Content-Type: application/json

{
  "action": "INVALID_ACTION"
}
```

**Expected Response:** `400 BAD REQUEST`

```json
{
  "status": 400,
  "message": "action must be either CONFIRMED or DECLINED",
  "timestamp": "2025-10-22T14:15:00"
}
```

---

### Test Case 1.7: Error - Respond to Non-Pending Renewal

**Objective:** Try to respond to already confirmed renewal

**Request:**

```bash
PATCH /api/v1/registrations/renewals/SRR251022001/respond
Authorization: Bearer <employee_token>
Content-Type: application/json

{
  "action": "CONFIRMED"
}
```

**Expected Response:** `400 BAD REQUEST`

```json
{
  "status": 400,
  "message": "Chỉ có thể phản hồi yêu cầu gia hạn ở trạng thái PENDING_ACTION. Yêu cầu này đang ở trạng thái: CONFIRMED",
  "timestamp": "2025-10-22T14:20:00"
}
```

---

### Test Case 1.8: Forbidden - Respond to Other's Renewal

**Objective:** Employee tries to respond to another employee's renewal

**Request:**

```bash
PATCH /api/v1/registrations/renewals/SRR251022003/respond
Authorization: Bearer <employee_token_id_5>
Content-Type: application/json

{
  "action": "CONFIRMED"
}
```

**Expected Response:** `403 FORBIDDEN`

```json
{
  "status": 403,
  "message": "Bạn không có quyền phản hồi yêu cầu gia hạn này",
  "timestamp": "2025-10-22T14:25:00"
}
```

**Validation:**

- ✅ Owner validation: only the employee who owns the registration can respond
- ✅ Prevents cross-employee manipulation

---

### Test Case 1.9: Error - Renewal Not Found

**Objective:** Request non-existent renewal ID

**Request:**

```bash
PATCH /api/v1/registrations/renewals/SRR999999999/respond
Authorization: Bearer <employee_token>
Content-Type: application/json

{
  "action": "CONFIRMED"
}
```

**Expected Response:** `404 NOT FOUND`

```json
{
  "status": 404,
  "message": "Shift renewal request not found with ID: SRR999999999",
  "timestamp": "2025-10-22T14:30:00"
}
```

---

## PART 2: Scheduled Batch Jobs

### Job 1: Monthly Full-Time Schedule Generation

**Job Name:** `MonthlyFullTimeScheduleJob`
**Cron Expression:** `0 0 2 20 * ?` (02:00 AM on the 20th day of every month)
**Timezone:** `Asia/Ho_Chi_Minh`

#### Purpose

Automatically creates next month's schedule for all FULL_TIME employees:

- Creates **MORNING** and **AFTERNOON** shifts for each working day
- Skips weekends (Saturday, Sunday)
- Skips public holidays from `holiday_dates` table

#### Test Case 2.1: Verify Job Execution

**Objective:** Check that job runs on schedule and creates correct shifts

**Test Steps:**

1. Wait for job to run on 20th day at 02:00 AM (or trigger manually)
2. Check application logs
3. Query employee_shifts table

**Expected Logs:**

```
[2025-10-20 02:00:00] INFO  MonthlyFullTimeScheduleJob - Starting monthly full-time schedule generation
[2025-10-20 02:00:00] INFO  MonthlyFullTimeScheduleJob - Found 5 full-time employees
[2025-10-20 02:00:00] INFO  MonthlyFullTimeScheduleJob - Generating schedule for month: 2025-11
[2025-10-20 02:00:00] INFO  MonthlyFullTimeScheduleJob - Loaded 2 holidays for November 2025
[2025-10-20 02:00:00] INFO  MonthlyFullTimeScheduleJob - Skipping weekend: 2025-11-01 (SATURDAY)
[2025-10-20 02:00:00] INFO  MonthlyFullTimeScheduleJob - Skipping weekend: 2025-11-02 (SUNDAY)
[2025-10-20 02:00:00] INFO  MonthlyFullTimeScheduleJob - Creating shifts for: 2025-11-03
[2025-10-20 02:00:00] INFO  MonthlyFullTimeScheduleJob - Skipping holiday: 2025-11-15 (Company Event)
[2025-10-20 02:00:01] INFO  MonthlyFullTimeScheduleJob - Successfully created 200 shifts for 5 employees (20 working days * 2 shifts/day)
```

**Database Verification:**

```sql
-- Check shifts created for next month
SELECT COUNT(*)
FROM employee_shifts
WHERE work_date >= '2025-11-01'
  AND work_date < '2025-12-01'
  AND source = 'BATCH_JOB';
-- Expected: (Number of full-time employees) × (Working days in Nov) × (2 shifts/day)

-- Verify no shifts on weekends
SELECT COUNT(*)
FROM employee_shifts
WHERE work_date >= '2025-11-01'
  AND work_date < '2025-12-01'
  AND source = 'BATCH_JOB'
  AND EXTRACT(DOW FROM work_date) IN (0, 6); -- Sunday=0, Saturday=6
-- Expected: 0

-- Verify no shifts on holidays
SELECT es.*
FROM employee_shifts es
JOIN holiday_dates hd ON es.work_date = hd.holiday_date
WHERE es.source = 'BATCH_JOB'
  AND es.work_date >= '2025-11-01';
-- Expected: 0 rows
```

---

#### Test Case 2.2: Verify Shift Details

**Objective:** Check that created shifts have correct data

**SQL Query:**

```sql
SELECT
  es.shift_id,
  es.employee_id,
  e.employee_name,
  es.work_date,
  ws.shift_name,
  es.source,
  es.status
FROM employee_shifts es
JOIN employees e ON es.employee_id = e.employee_id
JOIN work_shifts ws ON es.work_shift_id = ws.shift_id
WHERE es.work_date = '2025-11-03'
  AND es.source = 'BATCH_JOB'
ORDER BY es.employee_id, ws.start_time;
```

**Expected Results:**

```
| shift_id | employee_id | employee_name | work_date   | shift_name   | source    | status    |
|----------|-------------|---------------|-------------|--------------|-----------|-----------|
| 101      | 1           | Nguyen Van A  | 2025-11-03  | Ca sáng      | BATCH_JOB | SCHEDULED |
| 102      | 1           | Nguyen Van A  | 2025-11-03  | Ca chiều     | BATCH_JOB | SCHEDULED |
| 103      | 3           | Nguyen Van C  | 2025-11-03  | Ca sáng      | BATCH_JOB | SCHEDULED |
| 104      | 3           | Nguyen Van C  | 2025-11-03  | Ca chiều     | BATCH_JOB | SCHEDULED |
...
```

**Validation:**

- ✅ Each full-time employee has 2 shifts per working day (MORNING + AFTERNOON)
- ✅ source = 'BATCH_JOB'
- ✅ status = 'SCHEDULED'
- ✅ registration_id = NULL (not linked to registration)

---

### Job 2: Weekly Part-Time Schedule Generation

**Job Name:** `WeeklyPartTimeScheduleJob`
**Cron Expression:** `0 0 1 ? * SUN` (01:00 AM every Sunday)
**Timezone:** `Asia/Ho_Chi_Minh`

#### Purpose

Automatically creates next week's schedule for PART_TIME employees based on their active registrations:

- Reads `working_schedule` (employee_shift_registrations)
- Checks `registration_days` to see which days employee is registered
- Creates shifts for registered days only
- Skips public holidays

#### Test Case 2.3: Verify Job Execution

**Objective:** Check that job runs weekly and creates correct shifts

**Test Steps:**

1. Create active registration for part-time employee:

   ```sql
   INSERT INTO working_schedule (registration_id, employee_id, effective_from, effective_to, is_active)
   VALUES ('ESR251022001', 5, '2025-10-01', '2026-01-01', true);

   INSERT INTO registration_days (registration_id, day_of_week_id)
   VALUES ('ESR251022001', 1), -- MONDAY
          ('ESR251022001', 3), -- WEDNESDAY
          ('ESR251022001', 5); -- FRIDAY

   INSERT INTO registration_work_shifts (registration_id, shift_id)
   VALUES ('ESR251022001', 'SLOT_MORNING');
   ```

2. Wait for job to run on Sunday at 01:00 AM
3. Check logs and database

**Expected Logs:**

```
[2025-10-27 01:00:00] INFO  WeeklyPartTimeScheduleJob - Starting weekly part-time schedule generation
[2025-10-27 01:00:00] INFO  WeeklyPartTimeScheduleJob - Found 3 active registrations
[2025-10-27 01:00:00] INFO  WeeklyPartTimeScheduleJob - Generating schedule for week: 2025-10-28 to 2025-11-03
[2025-10-27 01:00:00] INFO  WeeklyPartTimeScheduleJob - Processing registration: ESR251022001 for employee 5
[2025-10-27 01:00:00] INFO  WeeklyPartTimeScheduleJob - Employee 5 registered for days: [MONDAY, WEDNESDAY, FRIDAY]
[2025-10-27 01:00:00] INFO  WeeklyPartTimeScheduleJob - Creating shift for: 2025-10-28 (MONDAY)
[2025-10-27 01:00:00] INFO  WeeklyPartTimeScheduleJob - Creating shift for: 2025-10-30 (WEDNESDAY)
[2025-10-27 01:00:00] INFO  WeeklyPartTimeScheduleJob - Creating shift for: 2025-11-01 (FRIDAY)
[2025-10-27 01:00:01] INFO  WeeklyPartTimeScheduleJob - Successfully created 9 shifts from 3 registrations
```

**Database Verification:**

```sql
-- Check shifts created for next week
SELECT
  es.shift_id,
  es.employee_id,
  e.employee_name,
  es.work_date,
  TO_CHAR(es.work_date, 'Day') as day_name,
  ws.shift_name,
  es.source,
  es.registration_id
FROM employee_shifts es
JOIN employees e ON es.employee_id = e.employee_id
JOIN work_shifts ws ON es.work_shift_id = ws.shift_id
WHERE es.work_date BETWEEN '2025-10-28' AND '2025-11-03'
  AND es.source = 'REGISTRATION_JOB'
ORDER BY es.employee_id, es.work_date;
```

**Expected Results:**

```
| employee_id | employee_name | work_date   | day_name  | shift_name | source          | registration_id |
|-------------|---------------|-------------|-----------|------------|-----------------|-----------------|
| 5           | Nguyen Van E  | 2025-10-28  | Monday    | Ca sáng    | REGISTRATION_JOB| ESR251022001    |
| 5           | Nguyen Van E  | 2025-10-30  | Wednesday | Ca sáng    | REGISTRATION_JOB| ESR251022001    |
| 5           | Nguyen Van E  | 2025-11-01  | Friday    | Ca sáng    | REGISTRATION_JOB| ESR251022001    |
```

**Validation:**

- ✅ Shifts created ONLY for registered days (Mon, Wed, Fri - not Tue, Thu, Sat, Sun)
- ✅ source = 'REGISTRATION_JOB'
- ✅ registration_id links to source registration
- ✅ Holidays are skipped

---

#### Test Case 2.4: Verify Multiple Shifts Per Day

**Objective:** Part-time employee registered for multiple shifts on same day

**Test Data:**

```sql
INSERT INTO registration_work_shifts (registration_id, shift_id)
VALUES ('ESR251022001', 'SLOT_MORNING'),
       ('ESR251022001', 'SLOT_AFTERNOON');
```

**Expected Result:**
Employee 5 should have 2 shifts created for each registered day:

```
| work_date   | shift_name   |
|-------------|--------------|
| 2025-10-28  | Ca sáng      |
| 2025-10-28  | Ca chiều     |
| 2025-10-30  | Ca sáng      |
| 2025-10-30  | Ca chiều     |
| 2025-11-01  | Ca sáng      |
| 2025-11-01  | Ca chiều     |
```

---

### Job 3: Daily Renewal Detection

**Job Name:** `DailyRenewalDetectionJob`
**Cron Expression:** `0 0 1 * * ?` (01:00 AM every day)
**Timezone:** `Asia/Ho_Chi_Minh`

#### Purpose

Automatically detects registrations expiring in 7 days and creates renewal requests:

- Queries `working_schedule` where `effective_to = today + 7 days`
- Creates `shift_renewal_request` with status = PENDING_ACTION
- Sets expiry deadline = today + 7 days (employee has 7 days to respond)
- Prevents duplicate renewals

#### Test Case 2.5: Verify Renewal Creation

**Objective:** Check that renewal requests are created 7 days before expiration

**Test Steps:**

1. Create registration expiring in 7 days:

   ```sql
   INSERT INTO working_schedule (registration_id, employee_id, effective_from, effective_to, is_active)
   VALUES ('ESR251030001', 2, '2025-01-01', '2025-10-30', true);
   ```

2. Run job on 2025-10-23 (7 days before expiration)
3. Check logs and database

**Expected Logs:**

```
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Starting daily renewal detection
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Checking for registrations expiring on: 2025-10-30
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Found 1 expiring registration
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Creating renewal request for registration: ESR251030001
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Successfully created 1 renewal request
```

**Database Verification:**

```sql
SELECT * FROM shift_renewal_requests
WHERE expiring_registration_id = 'ESR251030001';
```

**Expected Result:**

```json
{
  "renewalId": "SRR251023001",
  "expiringRegistrationId": "ESR251030001",
  "employeeId": 2,
  "status": "PENDING_ACTION",
  "expiresAt": "2025-10-30T23:59:59",
  "message": "Đăng ký ca làm việc của bạn sẽ hết hạn vào ngày 30/10/2025. Vui lòng xác nhận gia hạn thêm 3 tháng.",
  "createdAt": "2025-10-23T01:00:00"
}
```

**Validation:**

- ✅ Renewal created exactly 7 days before expiration
- ✅ expiresAt = registration's effective_to
- ✅ status = PENDING_ACTION
- ✅ Message explains deadline and extension duration

---

#### Test Case 2.6: Verify No Duplicate Renewals

**Objective:** Job should not create duplicate renewal for same registration

**Test Steps:**

1. Run job again on 2025-10-23 (same day)
2. Check logs

**Expected Logs:**

```
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Found 1 expiring registration
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Renewal already exists for registration: ESR251030001 with status: PENDING_ACTION
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Successfully created 0 renewal requests (1 skipped)
```

**Database Verification:**

```sql
SELECT COUNT(*) FROM shift_renewal_requests
WHERE expiring_registration_id = 'ESR251030001'
  AND status = 'PENDING_ACTION';
-- Expected: 1 (not 2)
```

---

#### Test Case 2.7: Verify Expired Renewal Marking

**Objective:** Job marks PENDING_ACTION renewals as EXPIRED after deadline

**Test Steps:**

1. Create renewal with past expiresAt:

   ```sql
   INSERT INTO shift_renewal_requests (renewal_id, expiring_registration_id, employee_id, status, expires_at)
   VALUES ('SRR251010001', 'ESR251020001', 2, 'PENDING_ACTION', '2025-10-22T23:59:59');
   ```

2. Run job on 2025-10-23
3. Check database

**Expected Logs:**

```
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Marking expired renewals
[2025-10-23 01:00:00] INFO  DailyRenewalDetectionJob - Marked 1 renewal as EXPIRED
```

**Database Verification:**

```sql
SELECT status FROM shift_renewal_requests WHERE renewal_id = 'SRR251010001';
-- Expected: 'EXPIRED'
```

---

### Job 4: Annual Leave Balance Reset

**Job Name:** `AnnualLeaveBalanceResetJob`
**Cron Expression:** `0 1 0 1 1 ?` (00:01 AM on January 1st every year)
**Timezone:** `Asia/Ho_Chi_Minh`

#### Purpose

Resets annual leave balances for all employees on New Year's Day (placeholder - awaits LeaveBalanceService integration)

#### Test Case 2.8: Verify Job Structure (Placeholder)

**Objective:** Verify job is configured and will call LeaveBalanceService

**Expected Logs (Current):**

```
[2025-01-01 00:01:00] INFO  AnnualLeaveBalanceResetJob - Starting annual leave balance reset
[2025-01-01 00:01:00] WARN  AnnualLeaveBalanceResetJob - LeaveBalanceService.annualReset() not yet implemented
[2025-01-01 00:01:00] INFO  AnnualLeaveBalanceResetJob - Annual leave balance reset completed
```

**Future Expected Behavior:**

```
[2026-01-01 00:01:00] INFO  AnnualLeaveBalanceResetJob - Starting annual leave balance reset for year: 2026
[2026-01-01 00:01:00] INFO  LeaveBalanceService - Creating new balances for 50 employees
[2026-01-01 00:01:01] INFO  AnnualLeaveBalanceResetJob - Successfully reset balances for 50 employees
```

---

## PART 3: Employee Shifts API

### Test Case 3.1: Get Employee Shifts (VIEW_EMPLOYEE_SHIFT_ALL)

**Objective:** Manager views all employees' shifts

**Request:**

```bash
GET /api/v1/employee-shifts?workDate=2025-11-01&page=0&size=50&sort=workDate,asc
Authorization: Bearer <manager_token>
```

**Expected Response:** `200 OK`

```json
{
  "content": [
    {
      "shiftId": 101,
      "employeeId": 1,
      "employeeName": "Nguyen Van A",
      "workDate": "2025-11-01",
      "workShift": {
        "shiftId": "SLOT_MORNING",
        "shiftName": "Ca sáng",
        "startTime": "07:00:00",
        "endTime": "12:00:00"
      },
      "source": "BATCH_JOB",
      "status": "SCHEDULED"
    },
    {
      "shiftId": 105,
      "employeeId": 5,
      "employeeName": "Nguyen Van E",
      "workDate": "2025-11-01",
      "workShift": {
        "shiftId": "SLOT_MORNING",
        "shiftName": "Ca sáng",
        "startTime": "07:00:00",
        "endTime": "12:00:00"
      },
      "source": "REGISTRATION_JOB",
      "registrationId": "ESR251022001",
      "status": "SCHEDULED"
    }
  ],
  "totalElements": 2
}
```

---

### Test Case 3.2: Get Own Shifts (VIEW_EMPLOYEE_SHIFT_OWN)

**Objective:** Employee views only their own shifts

**Request:**

```bash
GET /api/v1/employee-shifts/my-shifts?startDate=2025-11-01&endDate=2025-11-07
Authorization: Bearer <employee_token>
```

**Expected Response:** `200 OK`

- Returns only shifts where employeeId = current user's employeeId

---

### Test Case 3.3: Filter by Source

**Objective:** Get shifts by specific source type

**Request:**

```bash
GET /api/v1/employee-shifts?source=REGISTRATION_JOB&workDate=2025-11-01
Authorization: Bearer <manager_token>
```

**Expected Response:** `200 OK`

- Returns only shifts with source = 'REGISTRATION_JOB'

---

### Test Case 3.4: Filter by Status

**Objective:** Get shifts by status

**Request:**

```bash
GET /api/v1/employee-shifts?status=COMPLETED&startDate=2025-10-01&endDate=2025-10-31
Authorization: Bearer <manager_token>
```

**Expected Response:** `200 OK`

- Returns only COMPLETED shifts for October

---

## Error Responses Reference

| Status Code | Message                                            | Cause                  |
| ----------- | -------------------------------------------------- | ---------------------- |
| 400         | "action must be CONFIRMED or DECLINED"             | Invalid action value   |
| 400         | "Only PENDING_ACTION renewals can be responded to" | Wrong status           |
| 403         | "Bạn không có quyền phản hồi yêu cầu này"          | Not renewal owner      |
| 403         | "Access Denied"                                    | Missing permission     |
| 404         | "Shift renewal request not found"                  | Invalid renewalId      |
| 404         | "Registration not found"                           | Invalid registrationId |

---

## Business Rules

### Renewal Request Lifecycle

1. **Creation (Day -7):**

   - DailyRenewalDetectionJob runs at 01:00 AM daily
   - Finds registrations with effective_to = today + 7 days
   - Creates renewal with status = PENDING_ACTION
   - Prevents duplicates (checks if PENDING_ACTION renewal exists)

2. **Employee Response:**

   - Employee has 7 days to respond (until effective_to date)
   - **CONFIRMED:** Registration's effective_to extended by 3 months
   - **DECLINED:** Registration ends on original effective_to date

3. **Expiration:**
   - If no response by expiresAt, job marks as EXPIRED
   - Registration ends on original effective_to date

### Shift Generation Rules

1. **Full-Time Employees:**

   - 2 shifts per working day (MORNING + AFTERNOON)
   - Skips weekends (Sat/Sun)
   - Skips holidays from holiday_dates table
   - Generated monthly on 20th day for next month

2. **Part-Time Employees:**

   - Shifts based on registration_days configuration
   - Can have multiple shifts per day if registered
   - Skips holidays
   - Generated weekly on Sunday for next week
   - Links to registration via registration_id

3. **Shift Sources:**
   - **BATCH_JOB:** From MonthlyFullTimeScheduleJob
   - **REGISTRATION_JOB:** From WeeklyPartTimeScheduleJob
   - **MANUAL:** Manually created by admin/manager
   - **OVERTIME:** From approved overtime request

### ID Formats

- Renewal ID: `SRRYYMMDDSSS` (SRR + date + sequence)
  - Example: SRR251022001 = Oct 22, 2025, sequence 001
- Registration ID: `ESRYYMMDDSSS` (ESR + date + sequence)
  - Example: ESR250101001 = Jan 1, 2025, sequence 001

---

## Monitoring & Troubleshooting

### Check Job Execution

```bash
# View scheduled job logs
tail -f application.log | grep "ScheduleJob"

# Check last execution times
SELECT
  job_name,
  last_execution_time,
  next_execution_time,
  status
FROM scheduled_job_execution
ORDER BY last_execution_time DESC;
```

### Debug Renewal Issues

```sql
-- Find all pending renewals
SELECT
  srr.renewal_id,
  srr.employee_id,
  e.employee_name,
  srr.expires_at,
  DATE_PART('day', srr.expires_at - NOW()) as days_remaining
FROM shift_renewal_requests srr
JOIN employees e ON srr.employee_id = e.employee_id
WHERE srr.status = 'PENDING_ACTION'
ORDER BY srr.expires_at;

-- Check if employee responded
SELECT
  renewal_id,
  status,
  confirmed_at,
  message
FROM shift_renewal_requests
WHERE employee_id = 2
ORDER BY created_at DESC;
```

### Debug Shift Generation Issues

```sql
-- Check if shifts were created for specific date
SELECT
  COUNT(*),
  source,
  status
FROM employee_shifts
WHERE work_date = '2025-11-01'
GROUP BY source, status;

-- Find gaps in full-time employee schedule
WITH expected_shifts AS (
  SELECT
    e.employee_id,
    d.work_date,
    ws.shift_id
  FROM employees e
  CROSS JOIN generate_series('2025-11-01'::date, '2025-11-30'::date, '1 day'::interval) d(work_date)
  CROSS JOIN (SELECT shift_id FROM work_shifts WHERE shift_id IN ('SLOT_MORNING', 'SLOT_AFTERNOON')) ws
  WHERE e.employment_type = 'FULL_TIME'
    AND EXTRACT(DOW FROM d.work_date) NOT IN (0, 6) -- Not weekend
    AND NOT EXISTS (SELECT 1 FROM holiday_dates hd WHERE hd.holiday_date = d.work_date)
)
SELECT
  exp.employee_id,
  exp.work_date,
  exp.shift_id
FROM expected_shifts exp
LEFT JOIN employee_shifts es ON
  exp.employee_id = es.employee_id
  AND exp.work_date = es.work_date
  AND exp.shift_id = es.work_shift_id
WHERE es.shift_id IS NULL;
```

---

## Test Execution Checklist

### Renewal API

- [ ] Test get pending renewals (1.1 - 1.3)
- [ ] Test respond CONFIRMED (1.4)
- [ ] Test respond DECLINED (1.5)
- [ ] Test validation errors (1.6 - 1.7)
- [ ] Test owner validation (1.8)
- [ ] Test not found (1.9)
- [ ] Verify 3-month extension in database

### Scheduled Jobs

- [ ] Verify MonthlyFullTimeScheduleJob runs (2.1 - 2.2)
- [ ] Verify WeeklyPartTimeScheduleJob runs (2.3 - 2.4)
- [ ] Verify DailyRenewalDetectionJob runs (2.5 - 2.7)
- [ ] Verify AnnualLeaveBalanceResetJob structure (2.8)
- [ ] Check job logs for errors
- [ ] Verify weekend/holiday skip logic
- [ ] Verify duplicate prevention

### Employee Shifts API

- [ ] Test VIEW_ALL permission (3.1)
- [ ] Test VIEW_OWN permission (3.2)
- [ ] Test filter by source (3.3)
- [ ] Test filter by status (3.4)

### Integration Testing

- [ ] End-to-end: Registration expiring → Renewal created → Employee confirms → Registration extended
- [ ] End-to-end: Registration expiring → No response → Marked EXPIRED → Registration ends
- [ ] Verify shifts created from extended registration
- [ ] Verify shifts stop after declined/expired renewal

---

**Last Updated:** October 22, 2025
**API Version:** v1
**Feature:** BE-307 - Shift Registration Renewal & Automated Scheduling
